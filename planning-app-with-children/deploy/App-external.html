<!DOCTYPE html>
<html>
<head>
    <title>Random App Name54555</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Toolbox",{singleton:!0,loadProjects:function(customFilterField){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["ObjectID","Name","Parent",customFilterField],limit:"Infinity"}).load({callback:function(records,operation){var data=Toolbox.buildCustomProjectData(records,customFilterField);deferred.resolve(data)}}),deferred},buildFieldAttributeStore:function(records,fieldName){var hashByObjectID=Toolbox.buildHashByField(records,"ObjectID"),projectsWithBuildingBlocks=Ext.Array.filter(records,function(record){return record.get(customField)&&record.get(customField).length>0}),data=Ext.Array.map(projectsWithBuildingBlocks,function(p){var path=Toolbox.getProjectPath(p,hashByObjectID),stringPath=Toolbox.getStringPath(path,hashByObjectID);return{Name:p.get("Name"),BuildingBlock:p.get(customField),ObjectID:p.get("ObjectID"),Path:stringPath,Ancestors:path}});return data},buildHashByField:function(records,field){var hash={};return Ext.Array.each(records,function(record){hash[record.get(field)]=record}),hash},buildCustomProjectData:function(records,customField){var hashByObjectID=Toolbox.buildHashByField(records,"ObjectID"),projectsWithBuildingBlocks=Ext.Array.filter(records,function(record){return record.get(customField)&&record.get(customField).length>0}),data=Ext.Array.map(projectsWithBuildingBlocks,function(p){var path=Toolbox.getProjectPath(p,hashByObjectID),stringPath=Toolbox.getStringPath(path,hashByObjectID);return{Name:p.get("Name"),BuildingBlock:p.get(customField),ObjectID:p.get("ObjectID"),Path:stringPath,Ancestors:path}});return data},getStringPath:function(path,hashByObjectID){var stringPath=_.map(path,function(p){return hashByObjectID[p].get("Name")||"--"});return stringPath.join("/")},getProjectPath:function(projectRecord,projectHashByObjectID){for(var parent=projectRecord.get("Parent")&&projectRecord.get("Parent").ObjectID,path=[projectRecord.get("ObjectID")];parent;){var parentRecord=projectHashByObjectID[parent];parentRecord?(path.unshift(projectHashByObjectID[parent].get("ObjectID")),parent=parentRecord.get("Parent")&&parentRecord.get("Parent").ObjectID):parent=null}return path}});
                Ext.define("Rally.ui.dialog.CustomChooserDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.customchooserdialog",height:400,width:600,layout:"fit",closable:!0,draggable:!0,config:{title:"Choose an Item",teamData:[],teamFields:[],multiple:!0,columns:[{text:"Name",dataIndex:"Name",flex:1},{text:"Building Block",dataIndex:"BuildingBlock"},{text:"Path",dataIndex:"Path",flex:3}],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0,selectedRecords:void 0,initialSelectedRecords:void 0,showRadioButtons:!0},constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},selectionCache:[],initComponent:function(){this.callParent(arguments),this.addEvents("itemchosen"),this.addCls(["chooserDialog","chooser-dialog"])},destroy:function(){this._destroyTooltip(),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.selectionButtonText,cls:"primary rly-small",scope:this,disabled:!0,userAction:"clicked done in dialog",handler:function(){this.fireEvent("itemchosen",this,this.getSelectedRecords()),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.introText&&this.addDocked({xtype:"component",componentCls:"intro-panel",html:this.introText}),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",border:!1,padding:"0 0 10px 0",items:this.getSearchBarItems()}),this.buildGrid(),this.selectionCache=this.getInitialSelectedRecords()||[]},getSelectedRecords:function(){return this.multiple?this.selectionCache:this.selectionCache[0]},getSearchBarItems:function(){return[{xtype:"triggerfield",cls:"rui-triggerfield chooser-search-terms",emptyText:"Search Keyword or ID",enableKeyEvents:!0,flex:1,itemId:"searchTerms",listeners:{keyup:function(textField,event){event.getKey()===Ext.EventObject.ENTER&&this._search()},afterrender:function(field){field.focus()},scope:this},triggerBaseCls:"icon-search chooser-search-icon"}]},getStoreFilters:function(){return[]},_getProjectDataStore:function(){var currentTeam=this.currentTeam,showHomeTeam="Home"===this.showHomeTeam;console.log("_getProjectDataStore",this.showHomeTeam,showHomeTeam),console.log("HomeTeam",showHomeTeam,"currentTeam",currentTeam);var data=Ext.Array.filter(this.teamData,function(team){return Ext.Array.contains(team.Ancestors,currentTeam)?showHomeTeam:showHomeTeam!==!0});return Ext.create("Rally.data.custom.Store",{data:data,fields:this.teamFields,pageSize:data.length,remoteFilter:!1})},buildGrid:function(){this.grid&&this.grid.destroy();var projectDataStore=this._getProjectDataStore(),selectionConfig={mode:this.multiple?"SIMPLE":"SINGLE",allowDeselect:!0};this.grid=Ext.create("Rally.ui.grid.Grid",Ext.Object.merge({columnCfgs:this.columns,enableEditing:!1,enableColumnHide:!1,enableColumnMove:!1,selModel:this.showRadioButtons||this.multiple?Ext.create("Rally.ui.selection.CheckboxModel",Ext.apply(selectionConfig,{enableKeyNav:!1,isRowSelectable:function(record){return!0}})):Ext.create("Ext.selection.RowModel",selectionConfig),showRowActionsColumn:!1,store:projectDataStore,viewConfig:{emptyText:Rally.ui.EmptyTextFactory.get("defaultText"),publishLoadMessages:!1,getRowClass:function(record){return Rally.util.Test.toBrowserTestCssClass("row",record.getId())}}},this.config.gridConfig)),this.mon(this.grid,{beforeselect:this._onGridSelect,beforedeselect:this._onGridDeselect,load:this._onGridLoad,scope:this}),this.add(this.grid),this._onGridReady()},_addTooltip:function(){this._destroyTooltip(),this.tooltip=Ext.create("Rally.ui.tooltip.ToolTip",{target:this.grid.getEl(),html:"You don't have permission to edit this item.",delegate:".disabled-row",anchor:"top",showDelay:0,showOnClick:!0})},_destroyTooltip:function(){this.tooltip&&this.tooltip.destroy()},_getStoreConfig:function(){var storeConfig=_.cloneDeep(this.getInitialConfig().storeConfig);return this._getSearchTerms()&&(storeConfig.search=this._getSearchTerms()),storeConfig.filters=(storeConfig.filters||[]).concat(this.getStoreFilters()),storeConfig},_enableDoneButton:function(){this.down("#doneButton").setDisabled(this.selectionCache.length?!1:!0)},_findRecordInSelectionCache:function(record){return _.findIndex(this.selectionCache,function(cachedRecord){return cachedRecord.get("ObjectID")===record.get("ObjectID")})},_onGridSelect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1===index&&(this.multiple||(this.selectionCache=[]),this.selectionCache.push(record)),this._enableDoneButton()},_onGridDeselect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1!==index&&this.selectionCache.splice(index,1),this._enableDoneButton()},_onGridReady:function(){return this.grid.rendered?this.grid.getStore().isLoading()?(this.mon(this.grid,"load",this._onGridReady,this,{single:!0}),void 0):(this._onGridLoad(),this.center(),void 0):(this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0}),void 0)},_isArtifactEditable:function(record){return Rally.environment.getContext().getPermissions().isProjectEditor(record.get("Project"))},_onGridLoad:function(){var defaultSelection=Ext.Array.from(this.selectedRef||this.selectedRecords);if(defaultSelection.length){var selectedRecords=_.compact(_.map(defaultSelection,function(ref){var recordIndex=this.grid.getStore().find("_ref",ref);return recordIndex>=0?this.grid.getStore().getAt(recordIndex):null},this));selectedRecords.length&&this.grid.getSelectionModel().select(selectedRecords)}else{var store=this.grid.store,records=[];_.each(this.selectionCache,function(record){var recordIndex=store.find("_ref",record.get("_ref"));if(-1!==recordIndex){var storeRecord=store.getAt(recordIndex);records.push(storeRecord)}}),records.length&&this.grid.getSelectionModel().select(records)}this._addTooltip(),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)},_search:function(){var terms=RegExp(this._getSearchTerms(),"gi");this.grid.getStore().filterBy(function(record){return terms?terms.test(record.get("Name"))||terms.test(record.get("Path"))||terms.test(record.get("c_BuildingBlock")):!0})},_getSearchTerms:function(){var textBox=this.down("#searchTerms");return textBox&&textBox.getValue()}});
                Ext.define("ExampleRecordMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.examplerecordmenuitem",clickHideDelay:1,config:{record:void 0,handler:function(){var currentTeam=this.record.get("Project").ObjectID;console.log("click example record menu item",this.subFeatureModel,"currentTeam",currentTeam,"showHomeTeam",this.showHomeTeam),console.log("text",this.text);var dlg=Ext.create("Rally.ui.dialog.CustomChooserDialog",{teamFields:this.teamFields,showHomeTeam:this.showHomeTeam,currentTeam:currentTeam,teamData:this.teamData,listeners:{scope:this,itemchosen:function(dlg,selectedTeam){console.log("team chosen",selectedTeam,this.subFeatureModel),this.createSubFeatures(this.record,selectedTeam,this.subFeatureModel)}}});dlg.show()},predicate:function(record){return!0},text:"Example Record Menu Item..."},constructor:function(config){this.initConfig(config),this.callParent(arguments)},createSubFeatures:function(record,teams,subfeatureModel){console.log("createSubFeatures record",record,"teams",teams,"subfeatureModel",subfeatureModel);var promises=[],me=this;Ext.Array.each(teams,function(team){var newObject=Ext.create(subfeatureModel,{Name:record.get("Name")+": "+team.get("BuildingBlock"),c_ProjectType:record.get("c_ProjectType"),Parent:record.get("_ref"),Project:"/project/"+team.get("ObjectID")});promises.push(function(){return me._saveObject(newObject)})}),Deft.Chain.sequence(promises).then({scope:this,success:this.onSuccess,failure:this.onError})},_saveObject:function(obj){var deffered=Ext.create("Deft.Deferred");return obj.save({callback:function(record,operation){console.log("newObjectSaveCallback",record,operation),operation.wasSuccessful()?deffered.resolve(record):deffered.reject(operation)}}),deffered.promise}});
                Ext.override(Rally.ui.menu.DefaultRecordMenu,{onSuccess:Ext.emptyFn,onError:Ext.emptyFn,_getMenuItems:function(){var record=this.getRecord(),items=[],popoverPlacement=this.popoverPlacement||Rally.ui.popover.Popover.DEFAULT_PLACEMENT;return items.push({xtype:"examplerecordmenuitem",view:this.view,record:record,text:"Add HomeBuildingBlock",teamData:this.teamData,teamFields:this.teamFields,subFeatureModel:this.subFeatureModel,showHomeTeam:"Home",onSuccess:this.onSuccess,onError:this.onError}),items.push({xtype:"examplerecordmenuitem",view:this.view,record:record,text:"Add VisitorBuildingBlock",teamData:this.teamData,teamFields:this.teamFields,subFeatureModel:this.subFeatureModel,showHomeTeam:"Visitor",onSuccess:this.onSuccess,onError:this.onError}),items}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",teamData:[],teamFields:[],parentTypePath:"portfolioitem/marketablefeature",subfeatureTypePath:"portfolioitem/engrsubfeature",subFeatureModel:null,launch:function(){Deft.Promise.all([this._loadProjects(),this._getModelObject(this.subfeatureTypePath)]).then({scope:this,success:function(results){this._buildProjectStore(results[0]),console.log("subFeatureModel",results[1],results[2]),this.subFeatureModel=results[1],this._buildStore()},failure:function(message){console.log("got error from load projects")}})},_getModelObject:function(name){var deffered=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:name,success:function(model){deffered.resolve(model)}}),deffered.promise},_buildBuildingBlockStore:function(records){},_buildProjectStore:function(records){console.log("record",records),this.teamData=Toolbox.buildCustomProjectData(records,"c_BuildingBlock"),this.teamFields=["Name","BuildingBlock","Path","ObjectID"]},_buildCustomStore:function(data,fields){return Ext.create("Rally.data.custom.Store",{fields:fields,data:data})},_loadProjects:function(){var deffered=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"project",autoLoad:!0,fetch:["Name","ObjectID","c_BuildingBlock","Parent"],listeners:{load:function(store,data,success){console.log("projects loaded",data),success?deffered.resolve(data):deffered.reject("Failed to load projects")}}}),deffered.promise},_loadSubFeatureRollup:function(){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:this.subfeatureTypePath,fetch:["Parent","ObjectID","c_TeamSprints"],limit:"Infinity",context:{project:null},filters:[{property:"Parent.ObjectID",operator:">",value:0}]}).load({callback:function(records,operation){if(operation.wasSuccessful()){var hash={};Ext.Array.each(records,function(r){var parent=r.get("Parent")&&r.get("Parent").ObjectID;parent&&(hash[parent]||(hash[parent]=0),hash[parent]+=r.get("c_TeamSprints")||0)}),deferred.resolve(hash)}else deferred.reject(operation.error.errors.join)(",")},scope:this}),deferred},_buildStore:function(){Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:this._getModels(),fetch:["ObjectID","Name","Project","c_TeamSprints","PlannedStartDate","PlannedEndDate","c_ProjectType","Children"],enableHierarchy:!0,autoLoad:!0}).then({success:this._createTreeGrid,scope:this})},_getModels:function(){return["portfolioitem/marketablefeature"]},_updateData:function(store){console.log("_updateData",store,store.tree.root);var records=store.tree.root.childNodes;records.length>0&&Ext.Array.each(records,function(r){r.get("Children")&&r.get("Children").Count>0&&r.getCollection("Children").load({callback:function(children,operation){console.log("collectionLoad",children,operation);var vals=_.map(children,function(r){return r.get("c_TeamSprints")||0});r.set("c_TeamSprints",Ext.Array.sum(vals))}})})},_createTreeGrid:function(store){this.down("rallygridboard")&&this.down("rallygridboard").destroy(),store.on("load",this._updateData,this),store.on("datachanged",this._updateData,this);var me=this;this.add({xtype:"rallygridboard",context:this.getContext(),modelNames:this._getModels(),toggleState:"grid",plugins:[{ptype:"rallygridboardcustomfiltercontrol",filterControlConfig:{modelNames:this._getModels(),stateful:!0,stateId:this.getContext().getScopedStateId("planning-custom-filter")},showOwnerFilter:!0,ownerFilterControlConfig:{stateful:!0,stateId:this.getContext().getScopedStateId("planning-owner-filter")}}],stateId:"blah",gridConfig:{store:store,storeConfig:{pageSize:200},enableBulkEdit:!0,columnCfgs:this._getColumnConfig(),bulkEditConfig:{items:[{xtype:"examplebulkrecordmenuitem"}]},rowActionColumnConfig:{listeners:{scope:this,success:function(){console.log("success grid")},error:function(operations){this.fireEvent("error",operations)}},menuOptions:{teamData:this.teamData,teamFields:this.teamFields,subFeatureModel:this.subFeatureModel,onSuccess:function(record){Rally.ui.notify.Notifier.show({message:"All Sub Features Created"});var grid=me.down("rallygridboard");grid&&grid.getGridOrBoard()&&grid.getGridOrBoard().getStore().reload()},onError:function(operation){Rally.ui.notify.Notifier.showError({message:"Error:  "+operation.error.errors.join(",")})}}}},height:this.getHeight()})},_getColumnConfig:function(){return["Name","Project",{dataIndex:"c_TeamSprints",text:"Team Sprints",renderer:this.getTeamSprintRenderer},"PlannedStartDate","PlannedEndDate"]},getTeamSprintRenderer:function(value,metaData,record){return value}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name54555",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
